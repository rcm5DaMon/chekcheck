<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sales Time Check</title>
  <style>
    /* Your styles remain as is for layout */
    .container { margin: 50px auto 40px auto; width: 600px; text-align: center; }
    .suggestions { font-size: 0.85rem; color: #555; margin-top: 4px; }
    .pill { display:inline-block; padding:6px 10px; border:1px solid #ddd; border-radius:999px; margin:6px 6px 0 0; cursor:pointer; user-select:none; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Sales Time Check</h2>
    <p>Enter your name and dealer to check recorded time spent.</p>

    <!-- Sales Name with datalist + pills -->
    <label for="salesNameInput">Sales Name</label>
    <input id="salesNameInput" type="text" placeholder="Type sales name..." list="salesNameList" autocomplete="off" />
    <datalist id="salesNameList"></datalist>
    <div class="suggestions" id="salesNameSuggestions"></div>

    <!-- Dealer Name -->
    <label for="dealerInput">Search dealer by name</label>
    <input id="dealerInput" type="text" placeholder="Type dealer name…" autocomplete="off" />
    <div class="suggestions" id="dealerSuggestions"></div>

    <!-- Status -->
    <div>
      <label>Status</label>
      <input id="status" type="text" disabled placeholder="—" />
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px;">
      <button id="reload">Reload Dealer List</button>
      <button id="goCheckout" disabled>Go to Checkout</button>
    </div>

    <p class="muted" style="margin-top:12px;">
      Tip: Allow location permission and use a phone outdoors for better accuracy.
    </p>
  </div>

  <script>
    // ============== Utilities ==============
    function parseCSV(text) {
      const rows = [];
      let row = [], cell = '', inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const c = text[i], n = text[i + 1];
        if (inQuotes) {
          if (c === '"' && n === '"') { cell += '"'; i++; }
          else if (c === '"') { inQuotes = false; }
          else { cell += c; }
        } else {
          if (c === '"') { inQuotes = true; }
          else if (c === ',') { row.push(cell); cell = ''; }
          else if (c === '\n') { row.push(cell); rows.push(row); row = []; cell = ''; }
          else if (c === '\r') { /* ignore CR */ }
          else { cell += c; }
        }
      }
      if (cell.length || row.length) { row.push(cell); rows.push(row); }
      return rows;
    }

    // ============== State & DOM ==============
    const salesNameInput = document.getElementById("salesNameInput");
    const salesNameSuggestions = document.getElementById("salesNameSuggestions");

    const dealerInput = document.getElementById("dealerInput");
    const dealerSuggestions = document.getElementById("dealerSuggestions");

    const statusEl = document.getElementById("status");

    const reloadBtn = document.getElementById("reload");
    const goCheckoutBtn = document.getElementById("goCheckout");

    const CSV_URL_DEALERS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS3Hpp6N8pjYkRMy-Pi58yCxZB5o-rCdQfnBv0Z_vHMq6Uii5uxG60BnpQVcsyDTg-X9-A-HPodXhpT/pub?output=csv";
    const CSV_URL_SALESMEN = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTiHz0jejmmecSnTe5uK3Kwt_kx7HYcvMwRRQ_OeS1TA4evqMUwl8srVUe164DbJnxjYcuKuUsHQiFm/pub?gid=472318377&single=true&output=csv";

    let DEALERS = [];
    let SALESPEOPLE = [];
    let SELECTED_DEALER = null;
    let SALES_NAME = "";

    // ============== Load Dealers ==============
    async function loadDealers() {
      dealerSuggestions.innerHTML = `<span class="spinner"></span><span class="muted">Loading dealers…</span>`;
      try {
        const res = await fetch(CSV_URL_DEALERS, { cache: "no-store" });
        if (!res.ok) throw new Error("Cannot fetch dealer CSV");
        const text = await res.text();
        const rows = parseCSV(text);
        if (!rows.length) throw new Error("Empty dealer CSV");

        const header = rows.shift();
        DEALERS = rows.map(r => ({ name: r[0], lat: r[1], lng: r[2] }));

        dealerSuggestions.innerHTML = DEALERS.map(d => `<div class="pill" onclick="selectDealer('${d.name}')">${d.name}</div>`).join("");
      } catch (e) {
        dealerSuggestions.innerHTML = `<span class="err">Error: ${e.message}</span>`;
      }
    }

    // ============== Load Salespeople ==============
    async function loadSalespeople() {
      try {
        const res = await fetch(CSV_URL_SALESMEN, { cache: "no-store" });
        if (!res.ok) throw new Error("Cannot fetch salespeople CSV");
        const text = await res.text();
        const rows = parseCSV(text);
        if (!rows.length) throw new Error("Empty salespeople CSV");

        SALESPEOPLE = rows.map(r => r[0]).filter(Boolean);
        salesNameSuggestions.innerHTML = SALESPEOPLE.map(n => `<div class="pill" onclick="selectSalesName('${n}')">${n}</div>`).join("");
      } catch (e) {
        console.error("Error loading salespeople:", e.message);
      }
    }

    loadDealers();
    loadSalespeople();

    // ============== Sales Name Suggestions ==============
    function renderSalesSuggestions(query) {
      const q = query.toLowerCase().trim();
      const list = SALESPEOPLE.filter(n => n.toLowerCase().includes(q)).slice(0, 20);
      salesNameSuggestions.innerHTML = list.map(n => `<div class="pill" onclick="selectSalesName('${n}')">${n}</div>`).join("");
    }

    salesNameInput.addEventListener("input", (e) => renderSalesSuggestions(e.target.value));

    window.selectSalesName = function(name) {
      SALES_NAME = name;
      salesNameInput.value = name;
    };

    // ============== Dealer Suggestions ==============
    function renderDealerSuggestions(query) {
      const q = query.toLowerCase().trim();
      const list = DEALERS.filter(d => d.name.toLowerCase().includes(q)).slice(0, 20);
      dealerSuggestions.innerHTML = list.map(d => `<div class="pill" onclick="selectDealer('${d.name}')">${d.name}</div>`).join("");
    }

    dealerInput.addEventListener("input", (e) => renderDealerSuggestions(e.target.value));

    window.selectDealer = function(dealerName) {
      SELECTED_DEALER = DEALERS.find(d => d.name === dealerName);
      dealerInput.value = dealerName;
      statusEl.value = "Dealer selected";
      goCheckoutBtn.disabled = false;
    };

    // ============== Time Check ==============
    async function checkTimeSpent() {
      if (!SELECTED_DEALER || !SALES_NAME) return false;

      // Replace with real-time data validation logic
      const currentTime = new Date();
      const isValidTime = currentTime.getMinutes() > 0; // Just an example check
      return isValidTime;
    }

    // ============== Checkout ==============
    goCheckoutBtn.addEventListener("click", () => {
      if (goCheckoutBtn.disabled) return;
      window.location.href = "https://your-checkout-page.com"; // TODO
    });
  </script>
</body>
</html>
